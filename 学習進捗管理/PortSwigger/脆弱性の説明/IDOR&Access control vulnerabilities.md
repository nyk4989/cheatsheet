# 脆弱性名: [IDOR/Access control vulnerabilities]  

## 1️ 概要 / 定義
- **アクセス制御とは？**
	- アクションの実行やリソースへのアクセスの制御を行う。(認証は別。)
	- Webアプリケーションの場合、アクセス制御は認証とセッション管理に依存する。
- **アクセス制御の方法**
	- [認証]:ユーザが本人であることを確認する。
	- [セッション管理]:同じユーザによって行われる後続のHTTP要求を識別する。
	- [アクセス制御]:ユーザが実行しようとしているアクションの実行が許可されるかどうかを決定する。
- **アクセス制御の種類**
	- [垂直アクセス制御]
		- 一般ユーザが管理者のみのアクションや機能の制御を行っている。
	- [水平アクセス制御]
		- 同じ権限のものの別のユーザの制御。簡単に説明すると同じ端末内のWindowsユーザ。これがWebにもある。
	- [コンテキスト依存のアクセス制御]
		- ユーザが誤った順序でアクションを実行することを防ぐ。
		- 例えばユーザが支払いを済ませた後に購入履歴を変更できないようにする。みたいな
---
## 2️ 攻撃の前提条件
- [攻撃が成立するために必要な前提条件]
- 例：認証済みである必要がある、特定の権限を持っている等
---
## 3️ 影響
- アクセス制御の脆弱性は、ユーザがリソースにアクセスしたり許可されていないアクションを実行したりできる。
---
## 4️ 何ができるか（攻撃成功時の具体例）
- アクセス制御の不備を利用して得た機能を使うことができる。例えば管理者ユーザの機能でユーザのパスワードリセットがあればそれができる。
---
## 5️ 攻撃フロー（手順化）
### ### 垂直権限昇格
- [ケース1]:**保護されていない機能**
	- 一般の画面からはリンクがない/adminの発見
	- robots.txtでも見つかる可能性があるが、Directory Bruteやるほうが早そう。
	- 想定しにくいURLの場合もJSなどで気付かれる可能性がある。
		```html
		<script>
			var isAdmin = false;
			if (isAdmin) {
				...
				var adminPanelTag = document.createElement('a');
				adminPanelTag.setAttribute('href', 'https://insecure-website.com/administrator-panel-yb556');
				adminPanelTag.innerText = 'Admin panel';
				...
			}
		</script>
		```
- [ケース2]:**パラメータベースのアクセス制御の不具合**
	- 前提知識:ログイン時にユーザのアクセス権またはロールを決定しその情報をユーザが管理できる場所に保存する。それには以下のようなものがある。
		1. 隠しフィールド
		2. クッキー
		3. 事前に設定されたクエリ文字列パラメータ。
	- アプリケーションは送信された値に基づいてアクセス制御をする。
		```URL
		https://insecure-website.com/login/home.jsp?admin=true
		https://insecure-website.com/login/home.jsp?role=1
		```
	- ↑この方法はユーザが値を変更したりできてしまうため安全ではない。
- 詳しくは取り上げないがほかにも
	- プラットフォームの誤った構成によるアクセス制御の不具合
	- URL マッチングの不一致によりアクセス制御が破綻する
### ### 水平権限昇格
水平権限昇格は、他のユーザのリソースにアクセスできる場合に発生する。
攻撃手法に関しては、ほぼほぼ垂直権限昇格と変わらない。
- [ケース1]:**パラメータベースのアクセス制御**
	- `https://insecure-website.com/myaccount?id=123`があった場合にidを書き換えてバイパスができないか。
- [ケース2]:**推測不可能なパラメータ値**
	- `id=8492954c-3c86-4ef4-bcb1-011015324690`となっている場合idの値が推測不可である。この場合は推測するのではなく、ユーザメッセージやその他の場所で公開されていないかを探すのが良い。
- [ケース3]:**リダイレクト時の情報漏洩**
	- ユーザのリソースへのアクセスを許可されていないことを検出し、ログインページにリダイレクトされることがある。しかしリダイレクトを含むレスポンスには標的ユーザの機密情報が含まれる可能性がある。
	
### ### 水平から垂直への権限昇格
より高い権限を侵害することで垂直権限昇格へ転換していく。手法は前の元のそこまで変わらない。

### ### 安全ではない直接オブジェクト参照(IDOR)
IDORは、アクセス制御のサブカテゴリである。IDORは、アプリケーションがユーザ入力を使用して、オブジェクトに直接アクセスし、その入力を改ざんして不正アクセスができてしまうことを言う。アクセス制御のバイパスの手段となりえる。
- URL:https://portswigger.net/web-security/access-control/idor
- [obsidian](obsidian://open?vault=CheatSheet&file=%E5%AD%A6%E7%BF%92%E9%80%B2%E6%8D%97%E7%AE%A1%E7%90%86%2FPortSwigger%2F%E8%84%86%E5%BC%B1%E6%80%A7%E3%81%AE%E8%AA%AC%E6%98%8E%2F%E5%AE%89%E5%85%A8%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%84%E7%9B%B4%E6%8E%A5%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E5%8F%82%E7%85%A7(IDOR))

---
## 6️ 検出方法（診断手法）
- 手動：
  - [具体的にどのツールを使い、どう検証するか]
- 自動：
  - [使用可能なツール名]
  - [どういう設定や条件で検出できるか]

## 7️ 判定基準
- [何をもって脆弱と判定するか]
- [ガイドライン（OWASP、CWEなど）や一般的な基準に照らして明文化]
- 例：認証なしで閲覧可能 / 特定操作が実行可能 / トークンがない 等

## 8️ 防御策 / 緩和策

## 9 Payload
---

## 【補足】理解すべき背景
- なぜこの脆弱性が成立するのか：
  - [仕様上、設計上、実装上、どの要素が原因か]
- よくある失敗事例：
  - [実際に企業や現場でありがちなミス]
- 関連する脆弱性・攻撃手法：
  - [他の脆弱性との関連性]